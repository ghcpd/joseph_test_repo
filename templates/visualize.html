<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Visualizations</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.plot.ly/plotly-2.35.2.min.js"></script>
  </head>
  <body>
    <div class="container my-4">
      <a href="{{ url_for('index') }}" class="btn btn-link">&larr; Back</a>
      <h2 class="mb-3">Visualizations</h2>

      <form method="get" class="row g-3 mb-4">
        <div class="col-auto">
          <input type="text" name="repo" class="form-control" placeholder="Filter by repo (owner/repo)" value="{{ repo or '' }}">
        </div>
        <div class="col-auto">
          <button type="submit" class="btn btn-primary">Apply</button>
        </div>
      </form>

      <div class="row">
        <div class="col-12 col-lg-6 mb-4">
          <div class="card">
            <div class="card-header">Top 10 repos by PR count (Merged Data)</div>
            <div class="card-body">
              <div id="merged_counts" style="height:350px;"></div>
            </div>
          </div>
        </div>

        <div class="col-12 col-lg-6 mb-4">
          <div class="card">
            <div class="card-header">PR Creation Time Series (Merged Data)</div>
            <div class="card-body">
              <div id="merged_time" style="height:350px;"></div>
            </div>
          </div>
        </div>

        <div class="col-12 col-lg-6 mb-4">
          <div class="card">
            <div class="card-header">Closing Issue Counts per Repo (PR Issue)</div>
            <div class="card-body">
              <div id="pr_issue_counts" style="height:350px;"></div>
            </div>
          </div>
        </div>

        <div class="col-12 col-lg-6 mb-4">
          <div class="card">
            <div class="card-header">PRs by Month/Year (PR Detail)</div>
            <div class="card-body">
              <div id="pr_detail_hist" style="height:350px;"></div>
            </div>
          </div>
        </div>

        <div class="col-12 mb-4">
          <div class="card">
            <div class="card-header">Top 10 Labels Across Issues</div>
            <div class="card-body">
              <div id="issue_label_top" style="height:350px;"></div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <script>
      const merged_counts = {{ merged_counts | tojson }};
      const merged_time = {{ merged_time | tojson }};
      const pr_issue_counts = {{ pr_issue_counts | tojson }};
      const pr_detail_hist = {{ pr_detail_hist | tojson }};
      const issue_label_top = {{ issue_label_top | tojson }};

      // Merged counts bar chart
      (function(){
        const labels = merged_counts.map(x => x[0]);
        const values = merged_counts.map(x => x[1]);
        const data = [{x: labels, y: values, type: 'bar'}];
        const layout = {margin: {t: 20}};
        Plotly.newPlot('merged_counts', data, layout, {displayModeBar: false});
      })();

      // Merged time series
      (function(){
        const labels = merged_time.map(x => x[0]);
        const values = merged_time.map(x => x[1]);
        const data = [{x: labels, y: values, type: 'scatter', mode: 'lines+markers'}];
        const layout = {margin: {t: 20}};
        Plotly.newPlot('merged_time', data, layout, {displayModeBar: false});
      })();

      // PR issue counts per repo
      (function(){
        const labels = pr_issue_counts.map(x => x[0]);
        const values = pr_issue_counts.map(x => x[1]);
        const data = [{x: labels, y: values, type: 'bar'}];
        const layout = {margin: {t: 20}};
        Plotly.newPlot('pr_issue_counts', data, layout, {displayModeBar: false});
      })();

      // PR detail histogram by month
      (function(){
        const labels = pr_detail_hist.map(x => x[0]);
        const values = pr_detail_hist.map(x => x[1]);
        const data = [{x: labels, y: values, type: 'bar'}];
        const layout = {margin: {t: 20}};
        Plotly.newPlot('pr_detail_hist', data, layout, {displayModeBar: false});
      })();

      // Issue label top
      (function(){
        const labels = issue_label_top.map(x => x[0]);
        const values = issue_label_top.map(x => x[1]);
        const data = [{labels: labels, values: values, type: 'pie'}];
        const layout = {margin: {t: 20}};
        Plotly.newPlot('issue_label_top', data, layout, {displayModeBar: false});
      })();
    </script>
  </body>
</html>
